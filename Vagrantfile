# -*- mode: ruby -*-
# vi: set ft=ruby :

# Check required plugins
# vagrant-reload : vagrant plugin install vagrant-reload
REQUIRED_PLUGINS = %w(vagrant-reload)
exit unless REQUIRED_PLUGINS.all? do |plugin|
  Vagrant.has_plugin?(plugin) || (
    puts "The #{plugin} plugin is required. Please install it with:"
    puts "$ vagrant plugin install #{plugin}"
    false
  )
end

Vagrant::configure("2") do | config |
	config.vm.synced_folder "./ansible", "/ansible", disabled: false
	config.vm.box = "ubuntu/bionic64" # Ubuntu 18.04.1 LTS
	config.vm.hostname = "MalwareLab"
	# if you have multiple nic available, a prompt will ask you which nic has to be bound
	# this setting cannot be automated
	config.vm.network "public_network"
	config.vm.provider "virtualbox" do | v |
		v.gui = false
		v.memory = 2048
		v.cpus = 2
	end

	config.vm.provision "shell", run: "always", inline: <<-SHELL
		#apt-get -y -qq update > /dev/null
		#apt-get -y -qq upgrade > /dev/null
		#apt-get -y -qq dist-upgrade > /dev/null

		#apt-get -y install software-properties-common
        #apt-add-repository --yes --update ppa:ansible/ansible
        #apt-get -y install ansible
	SHELL

	config.vm.provision "ansible_local" do | ansible |
		ansible.playbook = "/ansible/deploy_local.yml"
	end
	
	config.vm.provision "shell", run: "never", inline: <<-SHELL
		# Update pip and setuptools to the last version
		# Creating new Python virtual env for cuckoo + cuckoo installation
		#echo 'reboot is required'
		#echo 'rebooting...'
		
		# run cuckoo :
		# $ . /opt/venvcuckoo/bin/activate
		# $ cuckoo

	SHELL

	#config.vm.provision :reload

	config.vm.provision "shell", run: "always", inline: <<-SHELL
		cores=$(grep -c ^processor /proc/cpuinfo 2>/dev/null)
		[ "$cores" -eq "0" ] && cores=1
		threshold="${cores:-1}.0"
		if [ $(echo "`cut -f1 -d ' ' /proc/loadavg` < $threshold" | bc) -eq 1 ]; then
			echo "System information:"
			/usr/bin/landscape-sysinfo
		else
			echo "System information disabled due to load higher than $threshold"
		fi
	SHELL
end
