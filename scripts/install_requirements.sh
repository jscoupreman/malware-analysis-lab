#!/bin/bash

set -e

# Unlock Python repo
sed -i 's/ubuntu bionic main restricted/ubuntu bionic main universe/g' /etc/apt/sources.list
sed -i 's/ubuntu bionic-security main restricted/ubuntu bionic-security main universe/g' /etc/apt/sources.list
sed -i 's/ubuntu bionic-updates main restricted/ubuntu bionic-updates main universe/g' /etc/apt/sources.list

# Add VirtualBox Sources
echo deb http://download.virtualbox.org/virtualbox/debian xenial contrib | sudo tee -a /etc/apt/sources.list.d/virtualbox.list
wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -

apt -y update # TODO : remove warnings by editing /etc/apt/sources.list

# Install Python libraries
apt -y install python python-pip python-dev libffi-dev libssl-dev python-virtualenv python-setuptools libjpeg-dev zlib1g-dev swig

# In order to use the Django-based Web Interface, MongoDB is required:
apt -y install mongodb

# Install PostgreSQL as main database
apt -y install postgresql libpq-dev

# Install KVM
#apt -y install qemu-kvm libvirt-bin ubuntu-vm-builder bridge-utils python-libvirt

# Install VirtualBox as main virtualization software		
# TODO : check current VBox version and download the same VBox Extension Pack version
apt -y install virtualbox
#apt -y install virtualbox-ext-pack # <- doesn't work due to license agreement
wget https://download.virtualbox.org/virtualbox/5.2.18/Oracle_VM_VirtualBox_Extension_Pack-5.2.18.vbox-extpack
echo "y" | vboxmanage extpack install --replace Oracle_VM_VirtualBox_Extension_Pack-5.2.18.vbox-extpack
# or : vboxmanage extpack install Oracle_VM_VirtualBox_Extension_Pack-5.2.18.vbox-extpack --accept-license=56be48f923303c8cababb0bb4c478284b688ed23f16d775d729b89a2e8e5f9eb

# Install Pydeep plugin
apt -y install ssdeep libfuzzy-dev
ldconfig
pip install pydeep

# Install mitmproxy in order to intercept SSL/TLS generated traffic
apt -y install python3-venv
git clone https://github.com/mitmproxy/mitmproxy.git
cd mitmproxy
./dev.sh
#. venv/bin/activate
#py.test

# Configuring Cuckoo account
useradd cuckoo
#chpasswd << 'END'
#cuckoo:cuckoo
#END

usermod -a -G vboxusers cuckoo

# Install tcpdump and configura cuckoo account rights
apt -y install tcpdump apparmor-utils
aa-disable /usr/sbin/tcpdump # disable AppArmor for tcpdump
groupadd pcap
usermod -a -G pcap cuckoo
chgrp pcap /usr/sbin/tcpdump
setcap cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump

# Install Volatility
git clone https://github.com/volatilityfoundation/volatility.git
# TODO

# Install SWIG & M2Crypto
apt -y install swig
pip install m2crypto

# Install Guacamole daemon
apt -y install libguac-client-rdp0 libguac-client-vnc0 libguac-client-ssh0 guacd

# Raising max open file limits (file descriptors) -> logoff / login is required (reboot in this case)
echo "fs.file-max = 2097152" >> /etc/sysctl.conf
# check result with : cat /proc/sys/fs/file-max
sysctl -p
echo "* hard nofile 1000000" >> /etc/security/limits.conf
echo "* soft nofile 1000000" >> /etc/security/limits.conf
# check result with : ulimit -Hn && ulimit -Sn