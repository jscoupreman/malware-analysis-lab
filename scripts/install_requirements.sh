#!/bin/bash

set -e

echo "Installing requirements..."

# Unlock Python repo
sed -i 's/deb http:\/\/archive.ubuntu.com\/ubuntu bionic main restricted/\#deb http:\/\/archive.ubuntu.com\/ubuntu bionic main restricted/g' /etc/apt/sources.list
sed -i 's/deb http:\/\/security.ubuntu.com\/ubuntu bionic-security main restricted/\#deb http:\/\/security.ubuntu.com\/ubuntu bionic-security main restricted/g' /etc/apt/sources.list
sed -i 's/deb http:\/\/archive.ubuntu.com\/ubuntu bionic-updates main restricted/\#deb http:\/\/archive.ubuntu.com\/ubuntu bionic-updates main restricted/g' /etc/apt/sources.list
sed -i 's/bionic universe/bionic main universe/g' /etc/apt/sources.list
sed -i 's/bionic-security universe/bionic-security main universe/g' /etc/apt/sources.list
sed -i 's/bionic-updates universe/bionic-updates main universe/g' /etc/apt/sources.list

# Add VirtualBox Sources
echo deb http://download.virtualbox.org/virtualbox/debian xenial contrib | tee -a /etc/apt/sources.list.d/virtualbox.list
wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | apt-key add -

echo "Updating package source lists..."
apt-get -y -qq update > /dev/null
apt-get -y -qq upgrade > /dev/null
apt-get -y -qq dist-upgrade > /dev/null

# Install Python libraries
echo "Installing Python Libraries..."
apt-get -y -qq install python python-pip python-dev libffi-dev libssl-dev python-virtualenv python-setuptools libjpeg-dev zlib1g-dev swig > /dev/null

# In order to use the Django-based Web Interface, MongoDB is required:
echo "Installing mongodb..."
apt-get -y -qq install mongodb > /dev/null

# Install PostgreSQL as main database
echo "Installing postgresql..."
apt-get -y -qq install postgresql libpq-dev > /dev/null
exit
echo "Installing VirtualBox..."
# Install VirtualBox as main virtualization software		
# TODO : check current VBox version and download the same VBox Extension Pack version
apt-get -y -qq install virtualbox > /dev/null
#apt -y install virtualbox-ext-pack # <- doesn't work due to license agreement
wget https://download.virtualbox.org/virtualbox/5.2.18/Oracle_VM_VirtualBox_Extension_Pack-5.2.18.vbox-extpack
echo "y" | vboxmanage extpack install --replace Oracle_VM_VirtualBox_Extension_Pack-5.2.18.vbox-extpack
# or : vboxmanage extpack install Oracle_VM_VirtualBox_Extension_Pack-5.2.18.vbox-extpack --accept-license=56be48f923303c8cababb0bb4c478284b688ed23f16d775d729b89a2e8e5f9eb

# Install Pydeep plugin
apt -y install ssdeep libfuzzy-dev
ldconfig
pip install pydeep

# Install mitmproxy in order to intercept SSL/TLS generated traffic
apt -y install python3-venv
git clone https://github.com/mitmproxy/mitmproxy.git
cd mitmproxy
./dev.sh
#. venv/bin/activate
#py.test

# Configuring Cuckoo account
useradd cuckoo
#chpasswd << 'END'
#cuckoo:cuckoo
#END

usermod -a -G vboxusers cuckoo

# Install tcpdump and configura cuckoo account rights
apt -y install tcpdump apparmor-utils
aa-disable /usr/sbin/tcpdump # disable AppArmor for tcpdump
groupadd pcap
usermod -a -G pcap cuckoo
chgrp pcap /usr/sbin/tcpdump
setcap cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump

# Install Volatility
git clone https://github.com/volatilityfoundation/volatility.git
# TODO

# Install SWIG & M2Crypto
apt -y install swig
pip install m2crypto

# Install Guacamole daemon
apt -y install libguac-client-rdp0 libguac-client-vnc0 libguac-client-ssh0 guacd

# Raising max open file limits (file descriptors) -> logoff / login is required (reboot in this case)
echo "fs.file-max = 2097152" >> /etc/sysctl.conf
# check result with : cat /proc/sys/fs/file-max
sysctl -p
echo "* hard nofile 1000000" >> /etc/security/limits.conf
echo "* soft nofile 1000000" >> /etc/security/limits.conf
# check result with : ulimit -Hn && ulimit -Sn